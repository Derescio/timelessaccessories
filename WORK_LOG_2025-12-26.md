# Work Log - December 26, 2025

## Summary
Fixed critical double stock reduction bug affecting PayPal and Stripe payment processing. Inventory quantities were being incorrectly reduced by 2x the ordered amount after payment completion. Also resolved authentication and authorization issues affecting admin dashboard access and user data serialization.

## Issues Identified

### 1. PayPal Payment Flow - Double Stock Reduction
**Problem**: Stock was being reduced twice in the PayPal payment flow:
- Once via direct Prisma decrement in `approvePayPalOrder` function
- Once via `reduceActualStock()` function call
- Potentially a third time via webhook handler

**Location**: 
- `lib/actions/order.actions.ts` (lines 622-634, 648)
- `app/api/webhook/paypal/route.ts`

### 2. Stripe Payment Flow - Potential Double Reduction
**Problem**: While Stripe didn't have the same issue, it lacked protection against duplicate webhook events or race conditions.

**Location**: 
- `app/api/webhook/stripe/route.ts`

### 3. TypeScript Compilation Errors
**Problem**: `stockResult` variable was declared inside conditional blocks but used outside, causing scope errors.

**Location**: 
- `app/api/webhook/paypal/route.ts`
- `app/api/webhook/stripe/route.ts`

### 4. Authentication & Authorization Issues
**Problem**: Multiple auth-related issues affecting admin dashboard access:
- Admin page not redirecting unauthenticated users on Vercel deployment
- User role was `undefined` in NextAuth v5 middleware for admin users
- Decimal serialization error when accessing admin users page (`discountAmount` field)

**Location**: 
- `middleware.ts`
- `auth.config.ts`
- `auth.ts`
- `lib/actions/user.actions.ts`

## Solutions Implemented

### 1. PayPal Payment Flow Fix
- ✅ Removed duplicate direct Prisma decrement (lines 622-634 in `order.actions.ts`)
- ✅ Added payment status check in PayPal webhook to prevent double reduction
- ✅ Centralized all stock reduction to use `reduceActualStock()` function only
- ✅ Enhanced logging for better debugging

### 2. Stripe Payment Flow Protection
- ✅ Added payment status check in `checkout.session.completed` handler
- ✅ Added payment status check in `charge.succeeded` handler
- ✅ Both handlers now skip stock reduction if payment already processed
- ✅ Enhanced logging for better debugging

### 3. TypeScript Fixes
- ✅ Declared `stockResult` with proper typing outside conditional blocks
- ✅ Updated return statements to safely handle both scenarios
- ✅ Fixed scope issues in both PayPal and Stripe webhook handlers

### 4. Authentication & Authorization Fixes
- ✅ Fixed admin page redirection by adding proper middleware matcher configuration
- ✅ Implemented workaround for NextAuth v5 middleware limitation where custom fields (role) aren't available in middleware auth object
- ✅ Added comprehensive logging to debug auth object structure and role access
- ✅ Enhanced middleware to allow authenticated users through and rely on server-side check in `app/admin/layout.tsx` for definitive role verification
- ✅ Fixed Decimal serialization error by converting `discountAmount` to string in `getUsers` and `getUserById` functions

## Files Modified

1. **lib/actions/order.actions.ts**
   - Removed duplicate stock decrement logic
   - Added explanatory comment

2. **app/api/webhook/paypal/route.ts**
   - Added payment status validation
   - Fixed variable scoping
   - Enhanced logging

3. **app/api/webhook/stripe/route.ts**
   - Added payment status validation (both event handlers)
   - Fixed variable scoping
   - Enhanced logging

4. **middleware.ts**
   - Added matcher configuration for NextAuth middleware

5. **auth.config.ts**
   - Enhanced admin path protection with role checking
   - Added comprehensive logging for debugging auth object structure
   - Implemented workaround for NextAuth v5 middleware limitations

6. **auth.ts**
   - Added logging in JWT and session callbacks to verify role is set correctly
   - Explicitly set token properties (sub, name, email, role)

7. **lib/actions/user.actions.ts**
   - Fixed Decimal serialization for `discountAmount` field in `getUsers` and `getUserById` functions

8. **CHANGELOG.md**
   - Added entry for version 1.4.1 documenting all fixes

## Testing Status

- ✅ Build passes successfully
- ✅ TypeScript compilation errors resolved
- ⚠️ Manual testing recommended:
  - PayPal payment flow
  - Stripe payment flow
  - Verify stock reduction is exactly 1x ordered quantity

## Impact

### Critical Fix
- Prevents inventory from being incorrectly reduced by 2x
- Prevents potential overselling issues
- Ensures accurate stock levels

### Improved Reliability
- Handles race conditions between frontend and webhook processing
- Prevents duplicate stock reduction from multiple webhook events
- Better error handling and logging

## Next Steps

1. **Manual Testing**:
   - Test PayPal checkout and verify stock reduction
   - Test Stripe checkout and verify stock reduction
   - Monitor webhook logs during testing

2. **Production Deployment**:
   - Deploy to staging environment first
   - Monitor stock levels after deployment
   - Verify no duplicate reductions occur

3. **Monitoring**:
   - Set up alerts for unusual stock reduction patterns
   - Monitor webhook logs for any issues
   - Track inventory accuracy metrics

## Notes

- The fix maintains backward compatibility
- No database migrations required
- All changes are in application logic only
- Enhanced logging will help identify any future issues

